Test the command line client for dataset version managment.


Something like

# Show list of realm-trees with a status summary
$ drs-tree list --root=<drs-root> --product=p --institute=i --model=m ...

Defaults are taken from the config.

# Show detailed status
$ drs-tree status --root=<drs-root> ...

# Move to next version
$ drs-tree next ...

Imports for this test.

>>> import sys, os, shutil
>>> sys.path.append(os.path.dirname(__file__))
>>> from isenes.drslib.drs_command import main
>>> import gen_drs

Create a directory and build a drs-tree in it

>>> tmpdir = './drs_tree_example'
>>> if os.path.exists(tmpdir): shutil.rmtree(tmpdir)
>>> os.mkdir(tmpdir)
>>> gen_drs.write_eg2(tmpdir)

>>> cmd_args = "--root=%s --product=output --institute=TEST --model=HadCM3" % tmpdir
 
List the realm-trees

>>> cmd = "drs_tree list %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
.../output/TEST/HadCM3/1pctto4x/day/ocean  INITIAL
.../output/TEST/HadCM3/1pctto4x/day/atmos  INITIAL
==============================================================================

>>> cmd = "drs_tree todo %s --realm=atmos" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS +NORMALIZE_WHITESPACE
==============================================================================
Realm Tree ... todo for version 1
------------------------------------------------------------------------------
mv .../output/TEST/HadCM3/1pctto4x/day/atmos/rsus/r1i1p1/rsus_day_HadCM3_1pctto4x_r1i1p1_2001123114-2004010104.nc .../output/TEST/HadCM3/1pctto4x/day/atmos/files/rsus_r1i1p1_1/rsus_day_HadCM3_1pctto4x_r1i1p1_2001123114-2004010104.nc
...
ln -s .../output/TEST/HadCM3/1pctto4x/day/atmos/files/tas_r1i1p1_1/tas_day_HadCM3_1pctto4x_r1i1p1_2000010100-2001123114.nc .../output/TEST/HadCM3/1pctto4x/day/atmos/v1/tas/r1i1p1/tas_day_HadCM3_1pctto4x_r1i1p1_2000010100-2001123114.nc
==============================================================================

Upgrade one Realm Tree

>>> cmd = "drs_tree upgrade %s --realm=atmos" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
Upgrading .../output/TEST/HadCM3/1pctto4x/day/atmos to version 1 ... done
==============================================================================

>>> cmd = "drs_tree list %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
.../output/TEST/HadCM3/1pctto4x/day/ocean  INITIAL
.../output/TEST/HadCM3/1pctto4x/day/atmos  VERSIONED       1
==============================================================================

>>> cmd = "drs_tree upgrade %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
Upgrading .../output/TEST/HadCM3/1pctto4x/day/ocean to version 1 ... done
Realm Tree .../output/TEST/HadCM3/1pctto4x/day/atmos has no pending upgrades
==============================================================================

>>> cmd = "drs_tree list %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
.../output/TEST/HadCM3/1pctto4x/day/ocean  VERSIONED       1
.../output/TEST/HadCM3/1pctto4x/day/atmos  VERSIONED       1
==============================================================================

>>> cmd= "touch %s/output/TEST/HadCM3/1pctto4x/day/atmos/pr/r1i1p1/pr_day_HadCM3_1pctto4x_r1i1p1_2000010100-2001123114.nc" % tmpdir
>>> os.system(cmd)
0
>>> cmd = "drs_tree list %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
.../output/TEST/HadCM3/1pctto4x/day/ocean  VERSIONED       1
.../output/TEST/HadCM3/1pctto4x/day/atmos  VERSIONED_TRANS 1
==============================================================================

>>> cmd = "drs_tree upgrade %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
Realm Tree .../output/TEST/HadCM3/1pctto4x/day/ocean has no pending upgrades
Upgrading .../output/TEST/HadCM3/1pctto4x/day/atmos to version 2 ... done
==============================================================================

>>> cmd = "drs_tree list %s" % cmd_args
>>> main(cmd.split()) # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
.../output/TEST/HadCM3/1pctto4x/day/ocean  VERSIONED       1
.../output/TEST/HadCM3/1pctto4x/day/atmos  VERSIONED       2
==============================================================================

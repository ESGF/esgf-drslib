Test the command line client for dataset version managment.

Something like

# Show list of realm-trees with a status summary
$ drs-tree list --root=<drs-root> --incoming=<incoming-root> --product=p --institute=i --model=m ...

Defaults are taken from the config.

# Show detailed status
$ drs-tree status --root=<drs-root> ...

# Move to next version
$ drs-tree next ...

Test Prerequisites
==================

Import modules required to for this test.

>>> import sys, os, shutil
>>> sys.path.append(os.path.dirname(__file__))
>>> from drslib.drs_command import main
>>> import gen_drs

Create a directory and build a drs-tree in it called './drs_tree_example/cmip5'

>>> tmpdir = './drs_tree_example'
>>> drs_root = os.path.join(tmpdir, 'cmip5')
>>> incoming = os.path.join(tmpdir, 'incoming')
>>> if os.path.exists(tmpdir): shutil.rmtree(tmpdir)
>>> os.mkdir(tmpdir)
>>> os.mkdir(drs_root)
>>> gen_drs.write_eg2(tmpdir)

Create a function to run the drs_tree command.

>>> def do_drs_tree(subcommand, args=''):
... 	cmd = "drs_tree %s --root=%s --activity=cmip5 --incoming=%s --product=output \
...                        --institute=MOHC --version=20100101 \
...                        --model=HadCM3 %s" % (subcommand, drs_root, incoming, args)    
...     main(cmd.split())
 
List the realm-trees

>>> do_drs_tree('list') #doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1                 *
cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1                  *
==============================================================================

Show what manipulations will be done for next version

>>> do_drs_tree('todo', '--realm=atmos') # doctest:+ELLIPSIS +NORMALIZE_WHITESPACE
==============================================================================
Publisher Tree ... todo for version 20100101
------------------------------------------------------------------------------
mv .../tas_day_HadCM3_1pctto4x_r1i1p1_2001123114-2004010104.nc .../r1i1p1/files/tas_20100101/tas_day_HadCM3_1pctto4x_r1i1p1_2001123114-2004010104.nc
...
ln -s .../output/MOHC/HadCM3/1pctto4x/day/atmos/day/r1i1p1/files/tas_20100101/tas_day_HadCM3_1pctto4x_r1i1p1_2000010100-2001123114.nc .../output/MOHC/HadCM3/1pctto4x/day/atmos/day/r1i1p1/v20100101/tas/tas_day_HadCM3_1pctto4x_r1i1p1_2000010100-2001123114.nc
==============================================================================

Upgrade one PublisherTree

>>> do_drs_tree('upgrade', '--realm=atmos') # doctest:+ELLIPSIS
==============================================================================
Upgrading cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1 to version 20100101 ... done
==============================================================================

List the results

>>> do_drs_tree('list') # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1.v20100101        -
cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1                 *
==============================================================================

Upgrade the other PublisherTree

>>> do_drs_tree('upgrade') # doctest:+ELLIPSIS
==============================================================================
Publisher Tree cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1 has no pending upgrades
Upgrading cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1 to version 20100101 ... done
==============================================================================

>>> do_drs_tree('list') # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1.v20100101        -
cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1.v20100101       -
==============================================================================

Simulate a new file ariving

>>> cmd= "cp %s/output/MOHC/HadCM3/1pctto4x/day/atmos/day/r1i1p1/v20100101/tas/tas_day_HadCM3_1pctto4x_r1i1p1_2004010104-2005123119.nc %s" % (drs_root, incoming)
>>> os.system(cmd)
0
>>> do_drs_tree('list') # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1.v20100101        *
cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1.v20100101       -
==============================================================================

>>> do_drs_tree('upgrade', '--version=20100102') # doctest:+ELLIPSIS
==============================================================================
Upgrading cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1 to version 20100102 ... done
Publisher Tree cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1 has no pending upgrades
==============================================================================

>>> do_drs_tree('list') # doctest:+ELLIPSIS
==============================================================================
DRS Tree at ...
------------------------------------------------------------------------------
cmip5.output.MOHC.HadCM3.1pctto4x.day.atmos.day.r1i1p1.v20100102        -
cmip5.output.MOHC.HadCM3.1pctto4x.mon.ocean.Omon.r1i1p1.v20100101       -
==============================================================================


